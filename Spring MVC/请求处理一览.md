# è¯·æ±‚å¤„ç†ä¸€è§ˆ

## 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥ä¸€è§ˆä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ï¼Œæ˜¯å¦‚ä½•è¢« DispatcherServlet å¤„ç†çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

FROM [ã€ŠSpring MVC åŸç†æ¢ç§˜ â€”â€” ä¸€ä¸ªè¯·æ±‚çš„æ—…è¡Œè¿‡ç¨‹ã€‹](https://www.tianxiaobo.com/2018/06/29/Spring-MVC-åŸç†æ¢ç§˜-ä¸€ä¸ªè¯·æ±‚çš„æ—…è¡Œè¿‡ç¨‹/)

![img](è¯·æ±‚å¤„ç†ä¸€è§ˆ.assets/15300766829012.jpg)



æ•´ä½“æµç¨‹å®é™…ä¸å¤æ‚ï¼Œä½†æ˜¯æ¶‰åŠçš„**å…¨éƒ¨**ä»£ç ä¼šéå¸¸å¤šï¼Œæ‰€ä»¥æœ¬æ–‡é‡ç‚¹åœ¨äºè§£æ**æ•´ä½“çš„æµç¨‹**ã€‚ç‰¹åˆ«å…·ä½“å’Œç»†èŠ‚çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬ä¼šæ”¾åˆ°åç»­çš„æ–‡ç« ï¼Œä¸€ç¯‡ä¸€ç¯‡ç»†ç»†å’€åš¼ã€‚

### 1.1 å¦‚ä½•è°ƒè¯•

æ¯”è¾ƒç®€å•ï¼Œè°ƒè¯• `org.springframework.web.servlet.DispatcherServletTests` è¿™ä¸ªå•å…ƒæµ‹è¯•ç±»ï¼Œå¯ä»¥è¿è¡Œå„ç§å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œæ‰§è¡Œå„ç§æƒ…å†µã€‚ğŸ˜ˆ



## 2. FrameworkServlet

è™½ç„¶åœ¨ [ã€Œ1. æ¦‚è¿°ã€](http://svip.iocoder.cn/Spring-MVC/DispatcherServlet-process-request-intro/#) çš„æ•´ä½“æµç¨‹å›¾ï¼Œæˆ‘ä»¬çœ‹åˆ°è¯·æ±‚é¦–å…ˆæ˜¯è¢« DispatcherServlet æ‰€å¤„ç†ï¼Œä½†æ˜¯å®é™…ä¸Šï¼ŒFrameworkServlet æ‰æ˜¯çœŸæ­£çš„å…¥é—¨ã€‚FrameworkServlet ä¼šå®ç°

- `#doGet(HttpServletRequest request, HttpServletResponse response)`
- `#doPost(HttpServletRequest request, HttpServletResponse response)`
- `#doPut(HttpServletRequest request, HttpServletResponse response)`
- `#doDelete(HttpServletRequest request, HttpServletResponse response)`
- `#doOptions(HttpServletRequest request, HttpServletResponse response)`
- `#doTrace(HttpServletRequest request, HttpServletResponse response)`
- `#service(HttpServletRequest request, HttpServletResponse response)`

ç­‰æ–¹æ³•ã€‚è€Œè¿™äº›å®ç°ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ `#processRequest(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚

### 2.1 ä¸åŒ HttpMethod çš„è¯·æ±‚å¤„ç†

#### 2.1.1 service

`#service(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// FrameworkServlet.java

@Override
protected void service(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	// <1> è·å¾—è¯·æ±‚æ–¹æ³•
	HttpMethod httpMethod = HttpMethod.resolve(request.getMethod());
	// <2.1> å¤„ç† PATCH è¯·æ±‚
	if (httpMethod == HttpMethod.PATCH || httpMethod == null) {
		processRequest(request, response);
	// <2.2> è°ƒç”¨çˆ¶ç±»ï¼Œå¤„ç†å…¶å®ƒè¯·æ±‚
	} else {
		super.service(request, response);
	}
}
```

- `<1>` å¤„ï¼Œè·å¾—è¯·æ±‚æ–¹æ³•ã€‚

- `<2.1>` å¤„ï¼Œè‹¥è¯·æ±‚æ–¹æ³•æ˜¯ `HttpMethod.PATCH` ï¼Œè°ƒç”¨ `#processRequest(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚å› ä¸º HttpServlet é»˜è®¤æ²¡æä¾› `#doPatch(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡çˆ¶ç±»çš„ `#service(...)` æ–¹æ³•ï¼Œä»è€Œå®ç°ã€‚å¦å¤–ï¼Œå…³äº processRequest çš„è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.2 processRequestã€](http://svip.iocoder.cn/Spring-MVC/DispatcherServlet-process-request-intro/#) ã€‚

- `<2.2>` å¤„ï¼Œå…¶å®ƒç±»å‹çš„è¯·æ±‚æ–¹æ³•ï¼Œè¿˜æ˜¯è°ƒç”¨çˆ¶ç±»çš„ `#service(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œè¿›è¡Œå¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // HttpServlet.java
  
  protected void service(HttpServletRequest req, HttpServletResponse resp)
      throws ServletException, IOException {
      String method = req.getMethod();
  
      if (method.equals(METHOD_GET)) {
          long lastModified = getLastModified(req);
          if (lastModified == -1) {
              // servlet doesn't support if-modified-since, no reason
              // to go through further expensive logic
              doGet(req, resp);
          } else {
              long ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);
              if (ifModifiedSince < lastModified) {
                  // If the servlet mod time is later, call doGet()
                  // Round down to the nearest second for a proper compare
                  // A ifModifiedSince of -1 will always be less
                  maybeSetLastModified(resp, lastModified);
                  doGet(req, resp);
              } else {
                  resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
              }
          }
      } else if (method.equals(METHOD_HEAD)) {
          long lastModified = getLastModified(req);
          maybeSetLastModified(resp, lastModified);
          doHead(req, resp);
      } else if (method.equals(METHOD_POST)) {
          doPost(req, resp);
      } else if (method.equals(METHOD_PUT)) {
          doPut(req, resp);
      } else if (method.equals(METHOD_DELETE)) {
          doDelete(req, resp);
      } else if (method.equals(METHOD_OPTIONS)) {
          doOptions(req,resp);
      } else if (method.equals(METHOD_TRACE)) {
          doTrace(req,resp);
      } else {
          //
          // Note that this means NO servlet supports whatever
          // method was requested, anywhere on this server.
          //
  
          String errMsg = lStrings.getString("http.method_not_implemented");
          Object[] errArgs = new Object[1];
          errArgs[0] = method;
          errMsg = MessageFormat.format(errMsg, errArgs);
          
          resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);
      }
  }
  ```

å¯èƒ½ä¼šæœ‰èƒ–å‹æœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆä¸åœ¨ `#service(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ `#processRequest(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•å°±å¥½åˆ—ï¼Ÿå› ä¸ºé’ˆå¯¹ä¸åŒçš„è¯·æ±‚æ–¹æ³•ï¼Œå¤„ç†ç•¥å¾®æœ‰æ‰€ä¸åŒã€‚



#### 2.1.2 doGet & doPost & doPut & doDelete

è¿™å››ä¸ªæ–¹æ³•ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨ `#processRequest(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// FrameworkServlet.java

@Override
protected final void doGet(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	processRequest(request, response);
}

@Override
protected final void doPost(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	processRequest(request, response);
}

@Override
protected final void doPut(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	processRequest(request, response);
}

@Override
protected final void doDelete(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	processRequest(request, response);
}
```



#### 2.1.3 doOptions

```java
// FrameworkServlet.java

/** Should we dispatch an HTTP OPTIONS request to {@link #doService}?. */
private boolean dispatchOptionsRequest = false;

/**
 * Delegate OPTIONS requests to {@link #processRequest}, if desired.
 * <p>Applies HttpServlet's standard OPTIONS processing otherwise,
 * and also if there is still no 'Allow' header set after dispatching.
 * @see #doService
 */
@Override
protected void doOptions(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	// å¦‚æœ dispatchOptionsRequest ä¸º true ï¼Œåˆ™å¤„ç†è¯¥è¯·æ±‚
	if (this.dispatchOptionsRequest || CorsUtils.isPreFlightRequest(request)) {
	    // å¤„ç†è¯·æ±‚
	    processRequest(request, response);
		// å¦‚æœå“åº” Header åŒ…å« "Allow" ï¼Œåˆ™ä¸éœ€è¦äº¤ç»™çˆ¶æ–¹æ³•å¤„ç†
		if (response.containsHeader("Allow")) {
			// Proper OPTIONS response coming from a handler - we're done.
			return;
		}
	}

	// Use response wrapper in order to always add PATCH to the allowed methods
	// è°ƒç”¨çˆ¶æ–¹æ³•ï¼Œå¹¶åœ¨å“åº” Header çš„ "Allow" å¢åŠ  PATCH çš„å€¼
	super.doOptions(request, new HttpServletResponseWrapper(response) {
		@Override
		public void setHeader(String name, String value) {
			if ("Allow".equals(name)) {
				value = (StringUtils.hasLength(value) ? value + ", " : "") + HttpMethod.PATCH.name();
			}
			super.setHeader(name, value);
		}
	});
}

```

- é€‰è¯»ï¼Œå› ä¸º OPTIONS è¯·æ±‚æ–¹æ³•ï¼Œå®é™…åœºæ™¯ä¸‹ç”¨çš„å°‘ã€‚
- å¯å‚è€ƒ [ã€ŠHTTP çš„è¯·æ±‚æ–¹æ³• OPTIONSã€‹](https://blog.csdn.net/leikezhu1981/article/details/7402272) ã€‚

#### 2.1.4 doTrace

```java
// FrameworkServlet.java

/** Should we dispatch an HTTP TRACE request to {@link #doService}?. */
private boolean dispatchTraceRequest = false;

/**
 * Delegate TRACE requests to {@link #processRequest}, if desired.
 * <p>Applies HttpServlet's standard TRACE processing otherwise.
 * @see #doService
 */
@Override
protected void doTrace(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	// å¦‚æœ dispatchTraceRequest ä¸º true ï¼Œåˆ™å¤„ç†è¯¥è¯·æ±‚
	if (this.dispatchTraceRequest) {
		// å¤„ç†è¯·æ±‚
		processRequest(request, response);
		// å¦‚æœå“åº”çš„å†…å®¹ç±»å‹ä¸º "message/http" ï¼Œåˆ™ä¸éœ€è¦äº¤ç»™çˆ¶æ–¹æ³•å¤„ç†
		if ("message/http".equals(response.getContentType())) {
			// Proper TRACE response coming from a handler - we're done.
			return;
		}
	}

	// è°ƒç”¨çˆ¶æ–¹æ³•
	super.doTrace(request, response);
}
```

- é€‰è¯»ï¼Œå› ä¸º TRACE è¯·æ±‚æ–¹æ³•ï¼Œå®é™…åœºæ™¯ä¸‹ç”¨çš„å°‘ã€‚
- å¯å‚è¯» [ã€ŠHTTP Methodè¯¦ç»†è§£è¯»(`GET` `HEAD` `POST` `OPTIONS` `PUT` `DELETE` `TRACE` `CONNECT`)ã€‹](https://www.cnblogs.com/machao/p/5788425.html) çš„ [ã€Œ9.8 TRACEã€](http://svip.iocoder.cn/Spring-MVC/DispatcherServlet-process-request-intro/#) å°èŠ‚ã€‚



### 2.2 processRequest

`#processRequest(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// FrameworkServlet.java

protected final void processRequest(HttpServletRequest request, HttpServletResponse response)
		throws ServletException, IOException {
	// <1> è®°å½•å½“å‰æ—¶é—´ï¼Œç”¨äºè®¡ç®— web è¯·æ±‚çš„å¤„ç†æ—¶é—´
	long startTime = System.currentTimeMillis();
	// <2> è®°å½•å¼‚å¸¸
	Throwable failureCause = null;

	// <3> TODO èŠ‹è‰¿
	LocaleContext previousLocaleContext = LocaleContextHolder.getLocaleContext();
	LocaleContext localeContext = buildLocaleContext(request);

	// <4> TODO èŠ‹è‰¿
	RequestAttributes previousAttributes = RequestContextHolder.getRequestAttributes();
	ServletRequestAttributes requestAttributes = buildRequestAttributes(request, response, previousAttributes);

	// <5> TODO èŠ‹è‰¿
	WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);
	asyncManager.registerCallableInterceptor(FrameworkServlet.class.getName(), new RequestBindingInterceptor());

	// <6> TODO èŠ‹è‰¿
	initContextHolders(request, localeContext, requestAttributes);

	try {
		// <7> æ‰§è¡ŒçœŸæ­£çš„é€»è¾‘
		doService(request, response);
	} catch (ServletException | IOException ex) {
		failureCause = ex; // <8>
		throw ex;
	} catch (Throwable ex) {
		failureCause = ex; // <8>
		throw new NestedServletException("Request processing failed", ex);
	} finally {
		// <9> TODO èŠ‹è‰¿
		resetContextHolders(request, previousLocaleContext, previousAttributes);
		// <10> TODO èŠ‹è‰¿
		if (requestAttributes != null) {
			requestAttributes.requestCompleted();
		}
		// <11> æ‰“å°è¯·æ±‚æ—¥å¿—ï¼Œå¹¶ä¸”æ—¥å¿—çº§åˆ«ä¸º DEBUG 
		logResult(request, response, failureCause, asyncManager);
		// <12> å‘å¸ƒ ServletRequestHandledEvent äº‹ä»¶
		publishRequestHandledEvent(request, response, startTime, failureCause);
	}
}
```

- `<1>` å¤„ï¼Œè®°å½•å½“å‰æ—¶é—´ï¼Œç”¨äºè®¡ç®— web è¯·æ±‚çš„å¤„ç†æ—¶é—´ã€‚

- `<2>` å¤„ï¼Œè®°å½•å¼‚å¸¸ã€‚

- `<3>` å¤„ï¼ŒTODO 1001 Locale

- `<4>` å¤„ï¼ŒTODO 1002 RequestAttributes

- `<5>` å¤„ï¼ŒTODO 1003 Asyn

- `<6>` å¤„ï¼ŒTODO 1001 + 1002

- ã€é‡è¦ã€‘ `<7>` å¤„ï¼Œè°ƒç”¨ `#doService(HttpServletRequest request, HttpServletResponse response)` **æŠ½è±¡**æ–¹æ³•ï¼Œæ‰§è¡ŒçœŸæ­£çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```
  // FrameworkServlet.java
  
  protected abstract void doService(HttpServletRequest request, HttpServletResponse response)
  		throws Exception;
  ```

  - è¯¥**æŠ½è±¡**æ–¹æ³•ç”± DispatcherServlet å®ç°ï¼Œæ‰€ä»¥è¿™å°±æ˜¯ DispatcherServlet å¤„ç†è¯·æ±‚çš„**çœŸæ­£å…¥å£**ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ3. DispatcherServletã€](http://svip.iocoder.cn/Spring-MVC/DispatcherServlet-process-request-intro/#) ã€‚

- `<8>` å¤„ï¼Œè®°å½•æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæœ€ç»ˆåœ¨ `finally` çš„ä»£ç æ®µä¸­ä½¿ç”¨ã€‚

- `<9>` å¤„ï¼ŒTODO 1001 + 1002

- `<10>` å¤„ï¼ŒTODO 1001 + 1002

- `<11>` å¤„ï¼Œè°ƒç”¨ `#logResult(HttpServletRequest request, HttpServletResponse response, Throwable failureCause, WebAsyncManager asyncManager)` æ–¹æ³•ï¼Œæ‰“å°è¯·æ±‚æ—¥å¿—ï¼Œå¹¶ä¸”æ—¥å¿—çº§åˆ«ä¸º **DEBUG** ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œç‚¹å‡» [ä¼ é€é—¨](https://github.com/spring-projects/spring-framework/blob/master/spring-webmvc/src/main/java/org/springframework/web/servlet/FrameworkServlet.java#L1079-L1132) æŸ¥çœ‹ã€‚

- `<12>` å¤„ï¼Œè°ƒç”¨ `#publishRequestHandledEvent(HttpServletRequest request, HttpServletResponse response, long startTime, Throwable failureCause)` æ–¹æ³•ï¼Œå‘å¸ƒ `org.springframework.web.context.support.ServletRequestHandledEvent` äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// FrameworkServlet.java

/** Should we publish a ServletRequestHandledEvent at the end of each request?. */
private boolean publishEvents = true;

private void publishRequestHandledEvent(HttpServletRequest request, HttpServletResponse response,
		long startTime, @Nullable Throwable failureCause) {
	// å¦‚æœå¼€å¯å‘å¸ƒäº‹ä»¶
	if (this.publishEvents && this.webApplicationContext != null) {
		// Whether or not we succeeded, publish an event.
		long processingTime = System.currentTimeMillis() - startTime;
		// åˆ›å»º ServletRequestHandledEvent äº‹ä»¶ï¼Œå¹¶è¿›è¡Œå‘å¸ƒ
		this.webApplicationContext.publishEvent(
				new ServletRequestHandledEvent(this,
						request.getRequestURI(), request.getRemoteAddr(),
						request.getMethod(), getServletConfig().getServletName(),
						WebUtils.getSessionId(request), getUsernameForRequest(request),
						processingTime, failureCause, response.getStatus()));
	}
}
```

- å…³äº ServletRequestHandledEvent çš„ç›‘å¬ä½¿ç”¨ï¼Œå¯å‚è€ƒ [ã€Šä½¿ç”¨ Spring ApplicationListener å®¹å™¨ç›‘å¬å™¨æ¥è®°å½•è¯·æ±‚ä¿¡æ¯ã€‹](https://my.oschina.net/u/2419285/blog/1510163) ã€‚



## 3. DispatcherServlet

### 3.1 doService

`#doService(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼ŒDispatcherServlet çš„å¤„ç†è¯·æ±‚çš„å…¥å£æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
// DispatcherServlet.java

@Override
protected void doService(HttpServletRequest request, HttpServletResponse response) throws Exception {
	// <1> æ‰“å°è¯·æ±‚æ—¥å¿—ï¼Œå¹¶ä¸”æ—¥å¿—çº§åˆ«ä¸º DEBUG
    logRequest(request);

	// Keep a snapshot of the request attributes in case of an include,
	// to be able to restore the original attributes after the include.
	// <2> TODO èŠ‹è‰¿
	Map<String, Object> attributesSnapshot = null;
	if (WebUtils.isIncludeRequest(request)) {
		attributesSnapshot = new HashMap<>();
		Enumeration<?> attrNames = request.getAttributeNames();
		while (attrNames.hasMoreElements()) {
			String attrName = (String) attrNames.nextElement();
			if (this.cleanupAfterInclude || attrName.startsWith(DEFAULT_STRATEGIES_PREFIX)) {
				attributesSnapshot.put(attrName, request.getAttribute(attrName));
			}
		}
	}

	// Make framework objects available to handlers and view objects.
	// <3> è®¾ç½® Spring æ¡†æ¶ä¸­çš„å¸¸ç”¨å¯¹è±¡åˆ° request å±æ€§ä¸­
	request.setAttribute(WEB_APPLICATION_CONTEXT_ATTRIBUTE, getWebApplicationContext());
	request.setAttribute(LOCALE_RESOLVER_ATTRIBUTE, this.localeResolver);
	request.setAttribute(THEME_RESOLVER_ATTRIBUTE, this.themeResolver);
	request.setAttribute(THEME_SOURCE_ATTRIBUTE, getThemeSource());

	// <4> TODO èŠ‹è‰¿ flashMapManager
	if (this.flashMapManager != null) {
		FlashMap inputFlashMap = this.flashMapManager.retrieveAndUpdate(request, response);
		if (inputFlashMap != null) {
			request.setAttribute(INPUT_FLASH_MAP_ATTRIBUTE, Collections.unmodifiableMap(inputFlashMap));
		}
		request.setAttribute(OUTPUT_FLASH_MAP_ATTRIBUTE, new FlashMap());
		request.setAttribute(FLASH_MAP_MANAGER_ATTRIBUTE, this.flashMapManager);
	}

	try {
		// <5> æ‰§è¡Œè¯·æ±‚çš„åˆ†å‘
		doDispatch(request, response);
	} finally {
		// <6> TODO èŠ‹è‰¿
		if (!WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {
			// Restore the original attribute snapshot, in case of an include.
			if (attributesSnapshot != null) {
				restoreAttributesAfterInclude(request, attributesSnapshot);
			}
		}
	}
}
```

- `<1>` å¤„ï¼Œè°ƒç”¨ `#logRequest(HttpServletRequest request)` æ–¹æ³•ï¼Œæ‰“å°è¯·æ±‚æ—¥å¿—ï¼Œå¹¶ä¸”æ—¥å¿—çº§åˆ«ä¸º DEBUG ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œç‚¹å‡» [ä¼ é€é—¨](https://github.com/spring-projects/spring-framework/blob/master/spring-webmvc/src/main/java/org/springframework/web/servlet/DispatcherServlet.java#L954-L985) æŸ¥çœ‹ã€‚
- `<2>` å¤„ï¼ŒTODO 1003 èŠ‹è‰¿
- `<3>` å¤„ï¼Œè®¾ç½® Spring æ¡†æ¶ä¸­çš„å¸¸ç”¨å¯¹è±¡åˆ° `request` çš„å±æ€§ä¸­ã€‚
- `<4>` å¤„ï¼ŒTODO 1004 èŠ‹è‰¿ flashMapManager
- `<5>` å¤„ï¼Œè°ƒç”¨ `#doDispatch(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œæ‰§è¡Œè¯·æ±‚çš„åˆ†å‘ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ3.2 doDispatchã€](http://svip.iocoder.cn/Spring-MVC/DispatcherServlet-process-request-intro/#) ã€‚
- `<6>` å¤„ï¼ŒTODO 1003 èŠ‹è‰¿



### 3.2 doDispatch

`#doDispatch(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œæ‰§è¡Œè¯·æ±‚çš„åˆ†å‘ã€‚åœ¨å¼€å§‹çœ‹å…·ä½“çš„ä»£ç å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨æ¥å›å‘³ä¸‹è¿™å¼ å›¾ç‰‡ï¼š

FROM [ã€ŠSpring MVC åŸç†æ¢ç§˜ â€”â€” ä¸€ä¸ªè¯·æ±‚çš„æ—…è¡Œè¿‡ç¨‹ã€‹](https://www.tianxiaobo.com/2018/06/29/Spring-MVC-åŸç†æ¢ç§˜-ä¸€ä¸ªè¯·æ±‚çš„æ—…è¡Œè¿‡ç¨‹/)

![img](è¯·æ±‚å¤„ç†ä¸€è§ˆ.assets/15300766829012-1657645485588.jpg)

- å®é™…ä¸Šï¼Œè¿™å¼ å›¾ï¼Œæ›´å¤šçš„ååº”çš„æ˜¯ DispatcherServlet çš„ `#DispatcherServlet(...)` æ–¹æ³•çš„æ ¸å¿ƒæµç¨‹ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```java
// DispatcherServlet.java

protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception {
	HttpServletRequest processedRequest = request;
	HandlerExecutionChain mappedHandler = null;
	boolean multipartRequestParsed = false;

	// <1> TODO èŠ‹è‰¿
	WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);

	try {
		ModelAndView mv = null;
		Exception dispatchException = null;

		try {
			// TODO èŠ‹è‰¿
			processedRequest = checkMultipart(request);
			multipartRequestParsed = (processedRequest != request);

			// Determine handler for the current request.
			// <3> è·å¾—è¯·æ±‚å¯¹åº”çš„ HandlerExecutionChain å¯¹è±¡
			mappedHandler = getHandler(processedRequest);
			if (mappedHandler == null) { // <3.1> å¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™æ ¹æ®é…ç½®æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å› 404 é”™è¯¯
				noHandlerFound(processedRequest, response);
				return;
			}

			// Determine handler adapter for the current request.
			// <4> è·å¾—å½“å‰ handler å¯¹åº”çš„ HandlerAdapter å¯¹è±¡
			HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());

			// Process last-modified header, if supported by the handler.
			// <4.1> TODO èŠ‹è‰¿ last-modified
			String method = request.getMethod();
			boolean isGet = "GET".equals(method);
			if (isGet || "HEAD".equals(method)) {
				long lastModified = ha.getLastModified(request, mappedHandler.getHandler());
				if (new ServletWebRequest(request, response).checkNotModified(lastModified) && isGet) {
					return;
				}
			}

			// <5> å‰ç½®å¤„ç† æ‹¦æˆªå™¨
			if (!mappedHandler.applyPreHandle(processedRequest, response)) {
				return;
			}

			// Actually invoke the handler.
			// <6> çœŸæ­£çš„è°ƒç”¨ handler æ–¹æ³•ï¼Œå¹¶è¿”å›è§†å›¾
			mv = ha.handle(processedRequest, response, mappedHandler.getHandler());

			// <7> TODO èŠ‹è‰¿
			if (asyncManager.isConcurrentHandlingStarted()) {
				return;
			}

			// <8> TODO èŠ‹è‰¿ è§†å›¾
			applyDefaultViewName(processedRequest, mv);
			// <9> åç½®å¤„ç† æ‹¦æˆªå™¨
			mappedHandler.applyPostHandle(processedRequest, response, mv);
		} catch (Exception ex) {
			dispatchException = ex; // <10> è®°å½•å¼‚å¸¸
		} catch (Throwable err) {
			// As of 4.3, we're processing Errors thrown from handler methods as well,
			// making them available for @ExceptionHandler methods and other scenarios.
			dispatchException = new NestedServletException("Handler dispatch failed", err); // <10> è®°å½•å¼‚å¸¸
		}

		// <11> å¤„ç†æ­£å¸¸å’Œå¼‚å¸¸çš„è¯·æ±‚è°ƒç”¨ç»“æœã€‚
		processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException);
	} catch (Exception ex) {
		// <12> å·²å®Œæˆ æ‹¦æˆªå™¨
		triggerAfterCompletion(processedRequest, response, mappedHandler, ex);
	} catch (Throwable err) {
		// <12> å·²å®Œæˆ æ‹¦æˆªå™¨
		triggerAfterCompletion(processedRequest, response, mappedHandler,
				new NestedServletException("Handler processing failed", err));
	} finally {
		// <13.1> TODO èŠ‹è‰¿ï¼Œå¹²å•¥å­ï¼Ÿ
		if (asyncManager.isConcurrentHandlingStarted()) {
			// Instead of postHandle and afterCompletion
			if (mappedHandler != null) {
				mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);
			}
		} else {
			// <13.2> Clean up any resources used by a multipart request.
			if (multipartRequestParsed) {
				cleanupMultipart(processedRequest);
			}
		}
	}
}
```

- `<1>` å¤„ï¼ŒTODO 1003 Async

- `<2>` å¤„ï¼Œè°ƒç”¨ `#checkMultipart(HttpServletRequest request)` æ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ä¸Šä¼ è¯·æ±‚ã€‚å¦‚æœæ˜¯ï¼Œåˆ™å°è£…æˆ MultipartHttpServletRequest å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç è§£æ â€”â€” MultipartResolverã€‹](http://svip.iocoder.cn/Spring-MVC/MultipartResolver) ä¸­ã€‚

- `<3>` å¤„ï¼Œè°ƒç”¨ `#getHandler(HttpServletRequest request)` æ–¹æ³•ï¼Œè¿”å›è¯·æ±‚å¯¹åº”çš„æ˜¯ HandlerExecutionChain å¯¹è±¡ï¼Œå®ƒåŒ…å«å¤„ç†å™¨( `handler` )å’Œæ‹¦æˆªå™¨ä»¬( HandlerInterceptor æ•°ç»„ )ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // DispatcherServlet.java
  
  /** List of HandlerMappings used by this servlet. */
  @Nullable
  private List<HandlerMapping> handlerMappings;
     
  @Nullable
  protected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception {
  	if (this.handlerMappings != null) {
  		// éå† HandlerMapping æ•°ç»„
  		for (HandlerMapping mapping : this.handlerMappings) {
  			// è·å¾—è¯·æ±‚å¯¹åº”çš„ HandlerExecutionChain å¯¹è±¡
  			HandlerExecutionChain handler = mapping.getHandler(request);
  			// è·å¾—åˆ°ï¼Œåˆ™è¿”å›
  			if (handler != null) {
  				return handler;
  			}
  		}
  	}
  	return null;
  }
  ```

  - è¯¦ç»†çš„è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç åˆ†æ â€”â€” HandlerMapping ç»„ä»¶ï¼ˆäºŒï¼‰ä¹‹ HandlerInterceptorã€‹](http://svip.iocoder.cn/Spring-MVC/HandlerMapping-2-HandlerInterceptor)

- `<3.1>` å¤„ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è°ƒç”¨ `#noHandlerFound(HttpServletRequest request, HttpServletResponse response)` æ ¹æ®é…ç½®æŠ›å‡ºå¼‚å¸¸æˆ–è¿”å› 404 é”™è¯¯ã€‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡» [ä¼ é€é—¨](https://github.com/spring-projects/spring-framework/blob/master/spring-webmvc/src/main/java/org/springframework/web/servlet/DispatcherServlet.java#L1240-L1257) è‡ªå·±çœ‹è¯¥æ–¹æ³•ã€‚

- `<4>` å¤„ï¼Œè°ƒç”¨ `#getHandlerAdapter(Object handler)` æ–¹æ³•ï¼Œè·å¾—å½“å‰ `handler` å¯¹åº”çš„ HandlerAdapter å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // DispatcherServlet.java
  /** List of HandlerAdapters used by this servlet. */
  @Nullable
  private List<HandlerAdapter> handlerAdapters;    
  
  protected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException {
  	if (this.handlerAdapters != null) {
  		// éå† HandlerAdapter æ•°ç»„
  		for (HandlerAdapter adapter : this.handlerAdapters) {
   			// åˆ¤æ–­æ˜¯å¦æ”¯æŒå½“å‰å¤„ç†å™¨
  			if (adapter.supports(handler)) {
  				// å¦‚æœæ”¯æŒï¼Œåˆ™è¿”å›
  				return adapter;
  			}
  		}
  	}
  	// æ²¡æ‰¾åˆ°å¯¹åº”çš„ HandlerAdapter å¯¹è±¡ï¼ŒæŠ›å‡º ServletException å¼‚å¸¸
  	throw new ServletException("No adapter for handler [" + handler +
  			"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler");
  }
  
  ```

  - è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç è§£æ â€”â€” HandlerAdapter ç»„ä»¶ï¼ˆä¸€ï¼‰ä¹‹ HandlerAdapterã€‹](http://svip.iocoder.cn/Spring-MVC/HandlerAdapter-1-HandlerAdapter)

- `<4.1>` å¤„ï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç è§£æ â€”â€” HandlerAdapter ç»„ä»¶ï¼ˆä¸€ï¼‰ä¹‹ HandlerAdapterã€‹](http://svip.iocoder.cn/Spring-MVC/HandlerAdapter-1-HandlerAdapter)

- ã€æ‹¦æˆªå™¨ã€‘`<5>` å¤„ï¼Œè°ƒç”¨ `HandlerExecutionChain#applyPreHandle(HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œæ‹¦æˆªå™¨çš„å‰ç½®å¤„ç†ï¼Œå³è°ƒç”¨ `HandlerInterceptor#preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)` æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç åˆ†æ â€”â€” HandlerMapping ç»„ä»¶ï¼ˆäºŒï¼‰ä¹‹ HandlerInterceptorã€‹](http://svip.iocoder.cn/Spring-MVC/HandlerMapping-2-HandlerInterceptor) ã€‚

- ã€Controllerã€‘`<6>` å¤„ï¼Œè°ƒç”¨ `HandlerAdapter#handle(HttpServletRequest request, HttpServletResponse response, Object handler)` æ–¹æ³•ï¼ŒçœŸæ­£çš„è°ƒç”¨ `handler` æ–¹æ³•ï¼Œå¹¶è¿”å›è§†å›¾ã€‚è¿™é‡Œï¼Œä¸€èˆ¬å°±ä¼šè°ƒç”¨æˆ‘ä»¬å®šä¹‰çš„ Controller çš„æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ TODO ã€‚

- `<7>` å¤„ï¼ŒTODO 1003 Asyn

- `<8>` å¤„ï¼Œè°ƒç”¨ `#applyDefaultViewName(HttpServletRequest request, ModelAndView mv)` æ–¹æ³•ï¼Œå½“æ— è§†å›¾çš„æƒ…å†µä¸‹ï¼Œè®¾ç½®é»˜è®¤è§†å›¾ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // DispatcherServlet.java
  
  /** RequestToViewNameTranslator used by this servlet. */
  @Nullable
  private RequestToViewNameTranslator viewNameTranslator;
  
  private void applyDefaultViewName(HttpServletRequest request, @Nullable ModelAndView mv) throws Exception {
  	if (mv != null && !mv.hasView()) { // æ— è§†å›¾
  		// è·å¾—é»˜è®¤è§†å›¾
  		String defaultViewName = getDefaultViewName(request);
  		// è®¾ç½®é»˜è®¤è§†å›¾
  		if (defaultViewName != null) {
  			mv.setViewName(defaultViewName);
  		}
  	}
  }
  
  @Nullable
  protected String getDefaultViewName(HttpServletRequest request) throws Exception {
  	// ä»è¯·æ±‚ä¸­ï¼Œè·å¾—è§†å›¾
  	return (this.viewNameTranslator != null ? this.viewNameTranslator.getViewName(request) : null);
  }
  ```

  - è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç è§£æ â€”â€” RequestToViewNameTranslatorã€‹](http://svip.iocoder.cn/Spring-MVC/RequestToViewNameTranslator) ä¸­ã€‚

- ã€æ‹¦æˆªå™¨ã€‘`<9>` å¤„ï¼Œè°ƒç”¨ `HandlerExecutionChain#applyPostHandle(HttpServletRequest request, HttpServletResponse response, ModelAndView mv)` æ–¹æ³•ï¼Œæ‹¦æˆªå™¨çš„åç½®å¤„ç†ï¼Œå³è°ƒç”¨ `HandlerInterceptor#postHandle(HttpServletRequest request, HttpServletResponse response, Object handler)` æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç åˆ†æ â€”â€” HandlerMapping ç»„ä»¶ï¼ˆäºŒï¼‰ä¹‹ HandlerInterceptorã€‹](http://svip.iocoder.cn/Spring-MVC/HandlerMapping-2-HandlerInterceptor) ã€‚

- `<10>` å¤„ï¼Œè®°å½•å¼‚å¸¸ã€‚**æ³¨æ„**ï¼Œæ­¤å¤„ä»…ä»…è®°å½•ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ç»Ÿä¸€äº¤ç»™ `<11>` å¤„ç†ã€‚

- `<11>` å¤„ï¼Œè°ƒç”¨ `#processDispatchResult(HttpServletRequest request, HttpServletResponse response, HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)` æ–¹æ³•ï¼Œå¤„ç†**æ­£å¸¸å’Œå¼‚å¸¸**çš„è¯·æ±‚è°ƒç”¨ç»“æœã€‚æ³¨æ„ï¼Œæ­£å¸¸çš„ã€å¼‚å¸¸çš„ï¼Œéƒ½ä¼šè¿›è¡Œå¤„ç†ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ3.3 processDispatchResultã€](http://svip.iocoder.cn/Spring-MVC/DispatcherServlet-process-request-intro/#) ã€‚

- ã€æ‹¦æˆªå™¨ã€‘`<12>` å¤„ï¼Œè°ƒç”¨ `#triggerAfterCompletion(HttpServletRequest request, HttpServletResponse response, HandlerExecutionChain mappedHandler, Exception ex)` æ–¹æ³•ï¼Œæ‹¦æˆªå™¨çš„å·²å®Œæˆå¤„ç†ï¼Œå³è°ƒç”¨ `HandlerInterceptor#triggerAfterCompletion(HttpServletRequest request, HttpServletResponse response, Exception ex)` æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç åˆ†æ â€”â€” HandlerMapping ç»„ä»¶ï¼ˆäºŒï¼‰ä¹‹ HandlerInterceptorã€‹](http://svip.iocoder.cn/Spring-MVC/HandlerMapping-2-HandlerInterceptor) ã€‚

- `<13.1>` å¤„ï¼ŒTODO 1003 Asyn

- `<13.2>` å¤„ï¼Œå¦‚æœæ˜¯ä¸Šä¼ è¯·æ±‚ï¼Œåˆ™è°ƒç”¨ `#cleanupMultipart(HttpServletRequest request)` æ–¹æ³•ï¼Œæ¸…ç†èµ„æºã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç è§£æ â€”â€” MultipartResolverã€‹](http://svip.iocoder.cn/Spring-MVC/MultipartResolver) ä¸­ã€‚



### 3.3 processDispatchResult

`#processDispatchResult(HttpServletRequest request, HttpServletResponse response, HandlerExecutionChain mappedHandler, ModelAndView mv, Exception exception)` æ–¹æ³•ï¼Œå¤„ç†**æ­£å¸¸å’Œå¼‚å¸¸**çš„è¯·æ±‚è°ƒç”¨ç»“æœã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// DispatcherServlet.java

private void processDispatchResult(HttpServletRequest request, HttpServletResponse response,
		@Nullable HandlerExecutionChain mappedHandler, @Nullable ModelAndView mv,
		@Nullable Exception exception) throws Exception {
	// <1> æ ‡è®°ï¼Œæ˜¯å¦æ˜¯ç”Ÿæˆçš„ ModelAndView å¯¹è±¡
	boolean errorView = false;

	// <2> å¦‚æœæ˜¯å¦å¼‚å¸¸çš„ç»“æœ
	if (exception != null) {
	    // æƒ…å†µä¸€ï¼Œä» ModelAndViewDefiningException ä¸­è·å¾— ModelAndView å¯¹è±¡
		if (exception instanceof ModelAndViewDefiningException) {
			logger.debug("ModelAndViewDefiningException encountered", exception);
			mv = ((ModelAndViewDefiningException) exception).getModelAndView();
		// æƒ…å†µäºŒï¼Œå¤„ç†å¼‚å¸¸ï¼Œç”Ÿæˆ ModelAndView å¯¹è±¡
		} else {
			Object handler = (mappedHandler != null ? mappedHandler.getHandler() : null);
			mv = processHandlerException(request, response, handler, exception);
			// æ ‡è®° errorView
			errorView = (mv != null);
		}
	}

	// Did the handler return a view to render?
	if (mv != null && !mv.wasCleared()) {
		// <3.1> æ¸²æŸ“é¡µé¢
		render(mv, request, response);
		// <3.2> æ¸…ç†è¯·æ±‚ä¸­çš„é”™è¯¯æ¶ˆæ¯å±æ€§
		if (errorView) {
			WebUtils.clearErrorRequestAttributes(request);
		}
	} else {
		if (logger.isTraceEnabled()) {
			logger.trace("No view rendering, null ModelAndView returned.");
		}
	}

	// <4> TODO èŠ‹è‰¿
	if (WebAsyncUtils.getAsyncManager(request).isConcurrentHandlingStarted()) {
		// Concurrent handling started during a forward
		return;
	}

	// <5> å·²å®Œæˆå¤„ç† æ‹¦æˆªå™¨
	if (mappedHandler != null) {
		mappedHandler.triggerAfterCompletion(request, response, null);
	}
}
```

- `<1>` å¤„ï¼Œ`errorView` å±æ€§ï¼Œæ ‡è®°æ˜¯å¦æ˜¯ç”Ÿæˆçš„ ModelAndView å¯¹è±¡ã€‚

- `<2>` å¤„ï¼Œå¦‚æœæ˜¯å¦**å¼‚å¸¸**çš„ç»“æœã€‚

  - `<2.1>` å¤„ï¼Œæƒ…å†µä¸€ï¼Œä» ModelAndViewDefiningException ä¸­è·å¾— ModelAndView å¯¹è±¡ã€‚

  - `<2.2>` å¤„ï¼Œæƒ…å†µäºŒï¼Œè°ƒç”¨ `#processHandlerException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)` æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ï¼Œç”Ÿæˆ ModelAndView å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

    ```java
    // DispatcherServlet.java
    
    @Nullable
    protected ModelAndView processHandlerException(HttpServletRequest request, HttpServletResponse response,
    		@Nullable Object handler, Exception ex) throws Exception {
    	// Success and error responses may use different content types
        // ç§»é™¤ PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE å±æ€§
    	request.removeAttribute(HandlerMapping.PRODUCIBLE_MEDIA_TYPES_ATTRIBUTE);
    
    	// Check registered HandlerExceptionResolvers...
    	// <a> éå† HandlerExceptionResolver æ•°ç»„ï¼Œè§£æå¼‚å¸¸ï¼Œç”Ÿæˆ ModelAndView å¯¹è±¡
    	ModelAndView exMv = null;
    	if (this.handlerExceptionResolvers != null) {
    		// éå† HandlerExceptionResolver æ•°ç»„
    		for (HandlerExceptionResolver resolver : this.handlerExceptionResolvers) {
    			// è§£æå¼‚å¸¸ï¼Œç”Ÿæˆ ModelAndView å¯¹è±¡
    		    exMv = resolver.resolveException(request, response, handler, ex);
    		    // ç”ŸæˆæˆåŠŸï¼Œç»“æŸå¾ªç¯
    			if (exMv != null) {
    				break;
    			}
    		}
    	}
    	// æƒ…å†µä¸€ï¼Œç”Ÿæˆäº† ModelAndView å¯¹è±¡ï¼Œè¿›è¡Œè¿”å›
    	if (exMv != null) {
    		// ModelAndView å¯¹è±¡ä¸ºç©ºï¼Œåˆ™è¿”å› null
    		if (exMv.isEmpty()) {
    			request.setAttribute(EXCEPTION_ATTRIBUTE, ex); // è®°å½•å¼‚å¸¸åˆ° request ä¸­
    			return null;
    		}
    		// We might still need view name translation for a plain error model...
    		// è®¾ç½®é»˜è®¤è§†å›¾
    		if (!exMv.hasView()) {
    			String defaultViewName = getDefaultViewName(request);
    			if (defaultViewName != null) {
    				exMv.setViewName(defaultViewName);
    			}
    		}
    		// æ‰“å°æ—¥å¿—
    		if (logger.isTraceEnabled()) {
    			logger.trace("Using resolved error view: " + exMv, ex);
    		}
    		if (logger.isDebugEnabled()) {
    			logger.debug("Using resolved error view: " + exMv);
    		}
    		// è®¾ç½®è¯·æ±‚ä¸­çš„é”™è¯¯æ¶ˆæ¯å±æ€§
    		WebUtils.exposeErrorRequestAttributes(request, ex, getServletName());
    		return exMv;
    	}
    	// æƒ…å†µäºŒï¼Œæœªç”Ÿæˆ ModelAndView å¯¹è±¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
    	throw ex;
    }
    ```

  - `<a>` å¤„ï¼Œéå† HandlerExceptionResolver æ•°ç»„ï¼Œè°ƒç”¨ `HandlerExceptionResolver#resolveException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)` æ–¹æ³•ï¼Œè§£æå¼‚å¸¸ï¼Œç”Ÿæˆ ModelAndView å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼ŒTODO

  - `<b>` å¤„ï¼Œæƒ…å†µä¸€ï¼Œç”Ÿæˆäº† ModelAndView å¯¹è±¡ï¼Œè¿›è¡Œè¿”å›ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„åç»­ä»£ç è¿˜æœ‰ 10 å¤šè¡Œï¼Œæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…å°± OK å•¦ã€‚

  - `<c>` å¤„ï¼Œæƒ…å†µäºŒï¼Œæœªç”Ÿæˆ ModelAndView å¯¹è±¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

- `<3.1>` å¤„ï¼Œè°ƒç”¨ `#render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œæ¸²æŸ“é¡µé¢ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ3.4 renderã€](http://svip.iocoder.cn/Spring-MVC/DispatcherServlet-process-request-intro/#) ã€‚

- `<3.2>` å¤„ï¼Œå½“æ˜¯ `<2>` å¤„çš„æƒ…å†µäºŒæ—¶ï¼Œåˆ™è°ƒç”¨ `WebUtils#clearErrorRequestAttributes(HttpServletRequest request)` æ–¹æ³•ï¼Œæ¸…ç†è¯·æ±‚ä¸­çš„é”™è¯¯æ¶ˆæ¯å±æ€§ã€‚ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸€æ­¥å‘¢ï¼Ÿç­”æ¡ˆåœ¨ `#processHandlerException(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)` æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ `WebUtils#exposeErrorRequestAttributes(HttpServletRequest request, Throwable ex, String servletName)` æ–¹æ³•ï¼Œè®¾ç½®è¯·æ±‚ä¸­çš„é”™è¯¯æ¶ˆæ¯å±æ€§ã€‚

- `<4>` å¤„ï¼ŒTODO 1003 èŠ‹è‰¿

- ã€æ‹¦æˆªå™¨ã€‘`<5>` å¤„ï¼Œè°ƒç”¨ `#triggerAfterCompletion(HttpServletRequest request, HttpServletResponse response, HandlerExecutionChain mappedHandler, Exception ex)` æ–¹æ³•ï¼Œæ‹¦æˆªå™¨çš„å·²å®Œæˆå¤„ç†ï¼Œå³è°ƒç”¨ `HandlerInterceptor#triggerAfterCompletion(HttpServletRequest request, HttpServletResponse response, Exception ex)` æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç åˆ†æ â€”â€” HandlerMapping ç»„ä»¶ï¼ˆäºŒï¼‰ä¹‹ HandlerInterceptorã€‹](http://svip.iocoder.cn/Spring-MVC/HandlerMapping-2-HandlerInterceptor) ã€‚



### 3.4 render

`#render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œæ¸²æŸ“ ModelAndView ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// DispatcherServlet.java

protected void render(ModelAndView mv, HttpServletRequest request, HttpServletResponse response) throws Exception {
	// Determine locale for request and apply it to the response.
	// <1> TODO èŠ‹è‰¿ ä» request ä¸­è·å¾— Locale å¯¹è±¡ï¼Œå¹¶è®¾ç½®åˆ° response ä¸­
	Locale locale = (this.localeResolver != null ? this.localeResolver.resolveLocale(request) : request.getLocale());
	response.setLocale(locale);

	// è·å¾— View å¯¹è±¡
	View view;
	String viewName = mv.getViewName();
	// æƒ…å†µä¸€ï¼Œä½¿ç”¨ viewName è·å¾— View å¯¹è±¡
	if (viewName != null) {
		// We need to resolve the view name.
		// <2.1> ä½¿ç”¨ viewName è·å¾— View å¯¹è±¡
		view = resolveViewName(viewName, mv.getModelInternal(), locale, request);
		if (view == null) { // è·å–ä¸åˆ°ï¼ŒæŠ›å‡º ServletException å¼‚å¸¸
			throw new ServletException("Could not resolve view with name '" + mv.getViewName() +
					"' in servlet with name '" + getServletName() + "'");
		}
	// æƒ…å†µäºŒï¼Œç›´æ¥ä½¿ç”¨ ModelAndView å¯¹è±¡çš„ View å¯¹è±¡
	} else {
		// No need to lookup: the ModelAndView object contains the actual View object.
		// ç›´æ¥ä½¿ç”¨ ModelAndView å¯¹è±¡çš„ View å¯¹è±¡
		view = mv.getView();
		if (view == null) { // è·å–ä¸åˆ°ï¼ŒæŠ›å‡º ServletException å¼‚å¸¸
			throw new ServletException("ModelAndView [" + mv + "] neither contains a view name nor a " +
					"View object in servlet with name '" + getServletName() + "'");
		}
	}

	// Delegate to the View object for rendering.
	// æ‰“å°æ—¥å¿—
	if (logger.isTraceEnabled()) {
		logger.trace("Rendering view [" + view + "] ");
	}
	try {
		// <3> è®¾ç½®å“åº”çš„çŠ¶æ€ç 
		if (mv.getStatus() != null) {
			response.setStatus(mv.getStatus().value());
		}
		// <4> æ¸²æŸ“é¡µé¢
		view.render(mv.getModelInternal(), request, response);
	} catch (Exception ex) {
		if (logger.isDebugEnabled()) {
			logger.debug("Error rendering view [" + view + "]", ex);
		}
		throw ex;
	}
}
```

- `<1>` å¤„ï¼Œè°ƒç”¨ `LocaleResolver#resolveLocale(HttpServletRequest request)` æ–¹æ³•ï¼Œä» `request` ä¸­è·å¾— Locale å¯¹è±¡ï¼Œå¹¶è®¾ç½®åˆ° `response` ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ TODO 1001

- `<2>` å¤„ï¼Œè·å¾— View å¯¹è±¡ã€‚åˆ†æˆä¸¤ç§æƒ…å†µï¼Œä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…ã€‚

- `<2.1>` å¤„ï¼Œè°ƒç”¨ `#resolveViewName(String viewName, Map<String, Object> model, Locale locale, HttpServletRequest request)` æ–¹æ³•ï¼Œä½¿ç”¨ `viewName` è·å¾— View å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // DispatcherServlet.java
  
  @Nullable
  protected View resolveViewName(String viewName, @Nullable Map<String, Object> model,
  		Locale locale, HttpServletRequest request) throws Exception {
  	if (this.viewResolvers != null) {
  	    // éå† ViewResolver æ•°ç»„
  		for (ViewResolver viewResolver : this.viewResolvers) {
  		    // æ ¹æ® viewName + locale å‚æ•°ï¼Œè§£æå‡º View å¯¹è±¡
  			View view = viewResolver.resolveViewName(viewName, locale);
  			// è§£ææˆåŠŸï¼Œç›´æ¥è¿”å› View å¯¹è±¡
  			if (view != null) {
  				return view;
  			}
  		}
  	}
  	// è¿”å›ç©º
  	return null;
  }
  ```

  - è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç è§£æ â€”â€” ViewResolverã€‹](http://svip.iocoder.cn/Spring-MVC/ViewResolver)

- `<3>` å¤„ï¼Œè®¾ç½®å“åº”çš„çŠ¶æ€ç ã€‚

- `<4>` å¤„ï¼Œè°ƒç”¨ `View#render(Map<String, ?> model, HttpServletRequest request, HttpServletResponse response)` æ–¹æ³•ï¼Œæ¸²æŸ“è§†å›¾ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Spring MVC æºç è§£æ â€”â€” ViewResolverã€‹](http://svip.iocoder.cn/Spring-MVC/ViewResolver) ã€‚



## 666. å½©è›‹

åˆ°æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¯¹ DispatcherServlet æ˜¯å¦‚ä½•å¤„ç†è¯·æ±‚å·²ç»æœ‰äº†æ•´ä½“çš„è®¤è¯†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¯¹æ¯ä¸ª Spring MVC ç»„ä»¶ï¼Œç»†èŠ‚æš‚æ—¶æ²¡æœ‰è¿›è¡Œæ·±æ‰£ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨çœ‹æœ¬æ–‡ï¼Œä¼šæœ‰å¤§é‡çš„ TODO ã€‚ä¸è¦æ–¹ï¼Œåé¢çš„æ¯ä¸€ç¯‡ï¼Œæˆ‘ä»¬ä¼šå¯¹æ¯ä¸ª Spring MVC ç»„ä»¶é€ä¸ªè§£æã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯¹ Spring MVC ä¼šæ›´åŠ äº†è§£ã€‚

å…¶å®ï¼Œè¿™ä¹Ÿæ˜¯çœ‹æºç çš„å¥—è·¯ï¼Œå…ˆæ•´ç†ï¼Œåå±€éƒ¨ï¼Œé€æ­¥é€æ­¥æŠ½ä¸å‰¥èŒ§ï¼Œçœ‹æ¸…ç†é€ã€‚

è¿˜æœ‰ï¼Œåœ¨çœ‹å®Œåç»­çš„ Spring MVC çš„æ¯ä¸ªç»„ä»¶åï¼Œèƒ–å‹å¯ä»¥åœ¨å›è¿‡å¤´åœ¨é‡æ–°çœ‹çœ‹è¿™ä¸ªæ–‡ç« ï¼Œæ˜¯å¦èƒ½å¤Ÿå°†æ–‡ç« æ›´å¥½çš„ä¸²è”åœ¨ä¸€èµ·ã€‚

------

ä¸‹é¢ï¼Œè‰¿è‰¿æ•´ç†äº†ä¸€äº›ç½‘ç»œä¸Šè®²è¿° Spring MVC å¤„ç†è¯·æ±‚çš„ä¸€äº›å›¾ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£è¿™ä¸ªè¿‡ç¨‹ã€‚

FROM [ã€ŠSpringMVC - è¿è¡Œæµç¨‹å›¾åŠåŸç†åˆ†æã€‹](https://blog.csdn.net/J080624/article/details/77990164)

**æµç¨‹ç¤ºæ„å›¾**ï¼š

![æµç¨‹ç¤ºæ„å›¾](è¯·æ±‚å¤„ç†ä¸€è§ˆ.assets/01.png)

â€‹                                                                                       æµç¨‹ç¤ºæ„å›¾

**ä»£ç åºåˆ—å›¾**ï¼š

![ä»£ç åºåˆ—å›¾](è¯·æ±‚å¤„ç†ä¸€è§ˆ.assets/02.png)

FROM [ã€Šçœ‹é€ Spring MVCï¼šæºä»£ç åˆ†æä¸å®è·µã€‹](https://item.jd.com/11807414.html) P123

**æµç¨‹ç¤ºæ„å›¾**ï¼š

![ã€Šæµç¨‹ç¤ºæ„å›¾ã€‹](è¯·æ±‚å¤„ç†ä¸€è§ˆ.assets/03-1657645939202.png)

â€‹															ã€Šæµç¨‹ç¤ºæ„å›¾ã€‹











